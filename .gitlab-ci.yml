# GitLab CI/CD Pipeline –¥–ª—è Django –ø—Ä–æ–µ–∫—Ç–∞
# –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —ç—Ç–∞–ø–∞–º–∏

stages:
  - validate      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
  - lint          # –õ–∏–Ω—Ç–∏–Ω–≥ –∫–æ–¥–∞
  - test          # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  - security      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  - build         # –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

# –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DJANGO_SETTINGS_MODULE: "shopproject.settings"

# –ö–µ—à –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python
cache:
  paths:
    - .cache/pip/
    - venv/

# ============================================
# STAGE: VALIDATE - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
# ============================================

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Python
validate-python-syntax:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Python —Ñ–∞–π–ª–æ–≤..."
    - python -m py_compile manage.py
    - find . -name "*.py" -not -path "./venv/*" -not -path "./.git/*" -exec python -m py_compile {} \;
    - echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å Python –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
  only:
    - merge_requests
    - main
    - develop

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ Django –Ω–∞—Å—Ç—Ä–æ–µ–∫
validate-django-settings:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Django..."
    - python manage.py check --deploy
    - python manage.py check
    - echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Django –≤–∞–ª–∏–¥–Ω—ã"
  only:
    - merge_requests
    - main
    - develop

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π Django
validate-migrations:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: "test_db"
    POSTGRES_USER: "postgres"
    POSTGRES_PASSWORD: "postgres"
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/test_db"
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install psycopg2-binary
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π Django..."
    - python manage.py makemigrations --check --dry-run
    - python manage.py migrate --check
    - echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤–∞–ª–∏–¥–Ω—ã"
  only:
    - merge_requests
    - main
    - develop

# ============================================
# STAGE: LINT - –õ–∏–Ω—Ç–∏–Ω–≥ –∫–æ–¥–∞
# ============================================

# –õ–∏–Ω—Ç–∏–Ω–≥ —Å flake8
lint-flake8:
  stage: lint
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install flake8
  script:
    - echo "üîç –õ–∏–Ω—Ç–∏–Ω–≥ –∫–æ–¥–∞ —Å flake8..."
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    - flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    - echo "‚úÖ –õ–∏–Ω—Ç–∏–Ω–≥ flake8 –∑–∞–≤–µ—Ä—à–µ–Ω"
  allow_failure: true
  artifacts:
    reports:
      codequality: flake8-report.json
    when: always
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å black
lint-black:
  stage: lint
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install black
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å black..."
    - black --check --diff .
    - echo "‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ"
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤ —Å isort
lint-isort:
  stage: lint
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install isort
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤..."
    - isort --check-only --diff .
    - echo "‚úÖ –ò–º–ø–æ—Ä—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# ============================================
# STAGE: TEST - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# ============================================

# –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤
test-unit:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: "test_db"
    POSTGRES_USER: "postgres"
    POSTGRES_PASSWORD: "postgres"
    DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/test_db"
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install psycopg2-binary pytest pytest-django pytest-cov
  script:
    - echo "üß™ –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤..."
    - python manage.py migrate
    - python manage.py test --verbosity=2
    - echo "‚úÖ Unit —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
test-coverage:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: "test_db"
    POSTGRES_USER: "postgres"
    POSTGRES_PASSWORD: "postgres"
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install psycopg2-binary coverage
  script:
    - echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º..."
    - python manage.py migrate
    - coverage run --source='.' manage.py test
    - coverage report -m
    - coverage html
    - echo "‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ"
  artifacts:
    paths:
      - htmlcov/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
test-staticfiles:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
    - python manage.py collectstatic --noinput --dry-run
    - echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
  only:
    - merge_requests
    - main
    - develop

# ============================================
# STAGE: SECURITY - –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
# ============================================

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
security-dependencies:
  stage: security
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --upgrade pip
    - pip install safety
  script:
    - echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö..."
    - safety check --file requirements.txt --json
    - echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏"
  allow_failure: true
  artifacts:
    reports:
      sast: safety-report.json
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
security-bandit:
  stage: security
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install bandit
  script:
    - echo "üîí –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏..."
    - bandit -r . -f json -o bandit-report.json || true
    - bandit -r . -ll
    - echo "‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
  allow_failure: true
  artifacts:
    reports:
      sast: bandit-report.json
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ
security-secrets:
  stage: security
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install detect-secrets
  script:
    - echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ..."
    - detect-secrets scan --baseline .secrets.baseline || true
    - echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# ============================================
# STAGE: BUILD - –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
# ============================================

# –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
build-docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    - docker push $CI_REGISTRY_IMAGE:latest
    - echo "‚úÖ Docker –æ–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω"
  only:
    - main
    - develop
  when: manual

# –°–±–æ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
build-staticfiles:
  stage: build
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
    - python manage.py collectstatic --noinput
    - echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Å–æ–±—Ä–∞–Ω—ã"
  artifacts:
    paths:
      - staticfiles/
    expire_in: 1 week
  only:
    - main
    - develop

# –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è –¥–µ–ø–ª–æ—è
build-archive:
  stage: build
  image: alpine:latest
  script:
    - echo "üèóÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
    - apk add --no-cache tar gzip
    - tar -czf project-${CI_COMMIT_SHORT_SHA}.tar.gz --exclude='.git' --exclude='venv' --exclude='__pycache__' .
    - echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω"
  artifacts:
    paths:
      - project-*.tar.gz
    expire_in: 1 week
  only:
    - main
    - develop
