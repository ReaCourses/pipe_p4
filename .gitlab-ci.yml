# GitLab CI/CD Pipeline –¥–ª—è Django –ø—Ä–æ–µ–∫—Ç–∞
# –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –¥–ª—è shell executor

stages:
  - validate    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
  - lint        # –õ–∏–Ω—Ç–∏–Ω–≥ –∫–æ–¥–∞
  - test        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  - build       # –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

# –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
variables:
  DJANGO_SETTINGS_MODULE: "shopproject.settings"

# ============================================
# STAGE: VALIDATE - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
# ============================================

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Python
validate-python-syntax:
  stage: validate
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Python —Ñ–∞–π–ª–æ–≤..."
    - python3 -m py_compile manage.py
    - python3 -c "import py_compile, os; [py_compile.compile(os.path.join(root, f)) for root, dirs, files in os.walk('.') for f in files if f.endswith('.py') and 'venv' not in root and '.git' not in root]"
    - echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å Python –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ Django –Ω–∞—Å—Ç—Ä–æ–µ–∫
validate-django-settings:
  stage: validate
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Django..."
    - python3 manage.py check
    - echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Django –≤–∞–ª–∏–¥–Ω—ã"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π Django (–±–µ–∑ –ë–î)
validate-migrations:
  stage: validate
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π Django..."
    - python3 manage.py makemigrations --check --dry-run
    - echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤–∞–ª–∏–¥–Ω—ã"

# ============================================
# STAGE: LINT - –õ–∏–Ω—Ç–∏–Ω–≥ –∫–æ–¥–∞
# ============================================

# –õ–∏–Ω—Ç–∏–Ω–≥ —Å flake8
lint-flake8:
  stage: lint
  before_script:
    - pip install flake8
  script:
    - echo "üîç –õ–∏–Ω—Ç–∏–Ω–≥ –∫–æ–¥–∞ —Å flake8..."
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
    - flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true
    - echo "‚úÖ –õ–∏–Ω—Ç–∏–Ω–≥ flake8 –∑–∞–≤–µ—Ä—à–µ–Ω "
  allow_failure: true

# ============================================
# STAGE: TEST - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# ============================================

# –ó–∞–ø—É—Å–∫ Django —Ç–µ—Å—Ç–æ–≤
test-django:
  stage: test
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "üß™ –ó–∞–ø—É—Å–∫ Django —Ç–µ—Å—Ç–æ–≤..."
    - python3 manage.py test --verbosity=2
    - echo "‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
test-staticfiles:
  stage: test
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
    - python3 manage.py collectstatic --noinput --dry-run
    - echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"

# ============================================
# STAGE: BUILD - –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
# ============================================

# –°–±–æ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
build-staticfiles:
  stage: build
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
    - python3 manage.py collectstatic --noinput
    - echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Å–æ–±—Ä–∞–Ω—ã"
  artifacts:
    paths:
      - staticfiles/
    expire_in: 1 week
  only:
    - main
    - master
    - develop
